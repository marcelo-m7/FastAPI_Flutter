# ğŸ—„ï¸ Boteco PRO Backend â€“ SQL Server & FastAPI

[![FastAPI](https://img.shields.io/badge/FastAPI-0.100+-green?logo=fastapi)](https://fastapi.tiangolo.com)
[![SQL Server](https://img.shields.io/badge/SQL%20Server-2019+-red?logo=microsoft-sql-server)](https://www.microsoft.com/en-us/sql-server)
[![Python](https://img.shields.io/badge/Python-3.9+-blue?logo=python)](https://www.python.org/)

---

## ğŸ“‹ Overview

The **Boteco PRO Backend** is a two-tier system: a powerful Microsoft SQL Server database with sophisticated stored procedures and views, paired with a FastAPI REST API for client integration.

This backend handles all business logic for a small restaurant/bar operation: orders, invoicing, inventory management, employee payroll, and financial reporting.

---

> **Developed by:** Marcelo Santos

---

## ğŸ—ï¸ Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Flutter App       â”‚ (Web, Android, iOS)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   FastAPI Gateway   â”‚ (REST endpoints, CORS, Auth)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   Business Logic    â”‚ (Stored Procedures, Functions)
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   SQL Server DB     â”‚ (Transactional Data, Views)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“¦ What's Inside

### 1ï¸âƒ£ Database Layer (`src/db/`)

**Initialization Scripts** (`init/`) â€” Executed in order:

| Script | Purpose | Key Objects Created |
|:-------|:--------|:-------------------|
| `00_Login.sql` | User & role setup | Login, database user |
| `01_CriaÃ§Ã£o_DB.sql` | Core schema | 20+ tables (3NF normalized) |
| `02_Base_Views.sql` | Reporting views | vw_EstoqueAtual, vw_ProdutosAbaixoMinimo, etc. |
| `03_Materialized_Views.sql` | Performance cache | mv_StocksUtilizadosPorPeriodo |
| `04_Functions.sql` | Reusable SQL logic | fn_ValorGastoVencimentos, fn_DetalhesFatura |
| `05_SP_Finalizar_Mesa.sql` | Invoice generation | sp_FinalizarMesaEGerarFatura |
| `06_SP_Realizar_Pedido.sql` | Order creation | sp_InserirPedidoCompleto |
| `07_Stored_Procedures.sql` | Reporting queries | Financial & operational reports |
| `08_Triggers.sql` | Auto-updates | Stock adjustments, MV refresh |
| `09_Function_Detalhes_Fatura.sql` | Invoice details | TVF for order-level breakdown |
| `10_Seeds_1.sql` | Sample data (Part 1) | Categories, suppliers, products |
| `11_Seeds_2.sql` | Sample data (Part 2) | Employees, menus, events |

**Use Case Procedures** (`use_cases/`) â€” Organized by domain:
- `Cadrastro Basico/` â€“ Basic CRUD operations
- `Especiais/` â€“ Special events & custom menus
- `Estoque/` â€“ Inventory management
- `FuncionÃ¡rios/` â€“ Employee & payroll management
- `Gestor/` â€“ Management reports & analytics
- `Pedidos/` â€“ Order processing workflow

---

### 2ï¸âƒ£ API Layer (`src/api/`)

**FastAPI Application Structure:**

```
api/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ main.py                 # FastAPI app initialization
â”‚   â”œâ”€â”€ db.py                   # SQL Server connection & pooling
â”‚   â”œâ”€â”€ senha_hash.py           # Password hashing (bcrypt)
â”‚   â”œâ”€â”€ routers/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ estoque.py          # Inventory endpoints
â”‚   â”‚   â”œâ”€â”€ faturas.py          # Invoice endpoints
â”‚   â”‚   â”œâ”€â”€ funcionarios.py     # Employee endpoints
â”‚   â”‚   â”œâ”€â”€ login.py            # Authentication & JWT
â”‚   â”‚   â”œâ”€â”€ pedidos.py          # Order endpoints
â”‚   â”‚   â”œâ”€â”€ produtos.py         # Product endpoints
â”‚   â”‚   â”œâ”€â”€ prats.py            # Dishes/meals endpoints
â”‚   â”‚   â””â”€â”€ ... (more routers)
â”‚   â””â”€â”€ models.py               # Pydantic data validation
â”œâ”€â”€ requirements.txt            # Python dependencies
â”œâ”€â”€ .env.example                # Environment template
â””â”€â”€ teste.py                    # Test utilities
```

---

## ğŸ—‚ï¸ Database Schema Highlights

### Core Tables (20+ entities)

**Sales & Orders:**
- `Mesa` (Tables) â†’ `Pedido` (Orders) â†’ `Pedido_Prato/Pedido_Bebida` (Line items)
- `Fatura` (Invoices) â€” Auto-generated by `sp_FinalizarMesaEGerarFatura`

**Inventory:**
- `Produto` (Products) with `Categoria` (Categories)
- `Estoque` (Stock levels) with automatic updates via triggers
- `EntradaEstoque` / `AjusteEstoque` (Stock movements)

**Recipes & Production:**
- `Receita` (Recipes) â†’ `ReceitaIngrediente` (Formula)
- `ProducaoCaseira` (In-house batches) â†’ `ProducaoIngrediente` (Batch contents)

**People:**
- `Funcionario` (Employees) with `Carreira` (Career levels)
- `Horas_Trabalhadas` (Time tracking)
- `Cliente` (Customers/Table mappings)

**Business:**
- `Fornecedor` (Suppliers)
- `Evento_Especial` (Special events)
- `Menu_Especial` (Seasonal menus)

### Advanced Features

**Views** (10+ for reporting):
- `vw_EstoqueAtual` â€“ Current stock snapshot
- `vw_ProdutosAbaixoMinimo` â€“ Low-stock alerts
- `vw_ValorGastoStocksPorPeriodo` â€“ Inventory cost analysis
- `vw_ValorRecebidoPorPeriodo` â€“ Revenue by period
- `vw_ResumoFinanceiroPorPeriodo` â€“ P&L summary

**Scalar Functions:**
- `fn_ValorGastoVencimentos(@mes, @ano)` â€“ Payroll calculation with overtime tiers

**Table-Valued Functions:**
- `fn_ValoresGastosStocks(@mes, @ano)` â€“ Detailed stock expenses
- `fn_DetalhesFatura(@id_fatura)` â€“ Invoice line-item breakdown

**Triggers:**
- `trg_AtualizarStock_Produtos` â€“ Auto-adjust stock on order creation
- `trg_ReporEstoque` â€“ Auto-generate replenishment alerts
- `trg_AtualizarMV_Stocks` â€“ Refresh materialized view

---

## ğŸš€ Getting Started

### Prerequisites

- **SQL Server 2019+** (Express, Standard, or Enterprise)
- **SQL Server Management Studio (SSMS)** or Azure Data Studio
- **Python 3.9+**
- **ODBC Driver 17 for SQL Server** (for pyodbc)
- **pip** or **pipenv** for dependency management

### 1ï¸âƒ£ Database Setup

```bash
# Open SQL Server Management Studio or Azure Data Studio
# Connect to your SQL Server instance

# Run scripts in order (copy & paste or use File > Open)
# Scripts are in: Backend/src/db/init/
```

**Windows (Command Line):**
```powershell
# If using sqlcmd
sqlcmd -S localhost\SQLEXPRESS -U sa -P YourPassword -i "00_Login.sql"
sqlcmd -S localhost\SQLEXPRESS -U sa -P YourPassword -i "01_CriaÃ§Ã£o_DB.sql"
# ... continue for all 11 scripts
```

> âš ï¸ **Important:** Execute scripts in numerical order. Dependencies exist between scripts.

For detailed instructions, see [Database Setup Guide](docs/INSTRUCOES_DB.md)

### 2ï¸âƒ£ API Setup

```bash
cd Backend/src/api

# Create virtual environment
python -m venv venv
# Windows:
venv\Scripts\activate
# macOS/Linux:
source venv/bin/activate

# Install dependencies
pip install -r requirements.txt

# Configure environment
cp .env.example .env
# â†’ Edit .env with your SQL Server connection details
# Example .env:
#   SQL_SERVER=localhost\SQLEXPRESS
#   SQL_USER=boteco_user
#   SQL_PASSWORD=YourSecurePassword
#   SQL_DATABASE=BotecoPRO

# Run the server
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

**Access the API:**
- ğŸ“š Swagger UI: http://localhost:8000/docs
- ğŸ“– ReDoc: http://localhost:8000/redoc
- ğŸ”— API Root: http://localhost:8000/

---

## ğŸ” Authentication Flow

```
1. Client sends POST /auth/login with username & password
         â†“
2. API queries sp_login or table Funcionario_Login
         â†“
3. Password hashed with bcrypt and compared
         â†“
4. JWT token generated (valid 24h by default)
         â†“
5. Client includes Authorization: Bearer <token> in headers
         â†“
6. API validates token on protected routes
```

---

## ğŸ“Š API Endpoints Overview

| Endpoint | Method | Purpose |
|:---------|:-------|:--------|
| `/auth/login` | POST | User authentication â†’ JWT token |
| `/produtos/` | GET | List all products |
| `/produtos/{id}` | GET | Get product details |
| `/produtos/` | POST | Create new product |
| `/estoque/` | GET | Current inventory snapshot |
| `/estoque/ajuste` | POST | Manual stock adjustment |
| `/pedidos/` | POST | Create new order |
| `/pedidos/{id}` | GET | Order details & items |
| `/faturas/mesa/{id}` | POST | Close table & generate invoice |
| `/funcionarios/` | GET | List employees |
| `/receitas/` | GET | List recipes |
| ... | ... | (40+ total endpoints) |

**Full API spec:** See [Boteco_PRO_API_Completo.yaml](docs/Boteco_PRO_API_Completo.yaml)

---

## ğŸ’¡ Key Implementation Details

### Performance Optimizations

- **Connection Pooling** â€“ Reuses DB connections via `pyodbc` pool
- **Async Endpoints** â€“ FastAPI's async/await for non-blocking I/O
- **Materialized Views** â€“ Pre-computed stock data for reporting
- **Indexes** â€“ Strategic indexes on foreign keys, order dates, product names

### Security Measures

- **Password Hashing** â€“ bcrypt with salt (cost factor 12)
- **JWT Authentication** â€“ Stateless token-based auth
- **CORS Configuration** â€“ Controlled cross-origin access
- **SQL Injection Prevention** â€“ Parameterized queries via pyodbc
- **Role-Based Access** â€“ Database-level permissions

### Data Integrity

- **Foreign Key Constraints** â€“ Enforced referential integrity
- **Triggers** â€“ Automated data consistency (stock updates, materialized views)
- **Transactions** â€“ Stored procedures use transactions for multi-step operations
- **3NF Normalization** â€“ Minimized redundancy & anomalies

---

## ğŸ§ª Testing

Manual testing via Swagger UI:

1. Navigate to http://localhost:8000/docs
2. Click "Authorize" â†’ enter test credentials
3. Try out any endpoint in the interactive interface
4. Responses include status codes & error details

---

## ğŸ“š Additional Documentation

- **[API Specification (OpenAPI/YAML)](docs/Boteco_PRO_API_Completo.yaml)** â€“ Complete endpoint definitions
- **[Database Structure](docs/ESTUTURA_DB.md)** â€“ ER diagram & table descriptions
- **[Database Setup Instructions](docs/INSTRUCOES_DB.md)** â€“ Step-by-step DB initialization
- **[Technical Report (PT)](docs/RelatÃ³rio_TP1.md)** â€“ Complete technical documentation

---

## ğŸ¤ Contributing

Found a bug or want to improve the API? Great! Here's how:

1. **Test the endpoint** thoroughly with different inputs
2. **Check the database** for data inconsistencies
3. **Open an issue** with reproduction steps
4. **Submit a PR** with the fix or improvement

---

## ğŸ“ Support & Questions

- **API Issues?** Check the endpoint documentation in Swagger UI
- **Database Questions?** Review the schema in [ESTUTURA_DB.md](docs/ESTUTURA_DB.md)
- **Setup Help?** See [INSTRUCOES_DB.md](docs/INSTRUCOES_DB.md)
- **Feature Request?** Open a GitHub issue

---

**Engineered with precision by Marcelo Santos**

> *"A well-structured database is the backbone of smooth operations."* â€“ **Boteco PRO Backend**
